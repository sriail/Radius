---
import SettingsLayout from "@layouts/SettingsLayout.astro";
import Switch from "@components/ui/Switch.astro";
import { Icon } from "astro-icon/components";
---
<SettingsLayout active="experiments" title="Experiments">
    <div class="w-full flex-grow">
        <div class="flex items-center gap-2 mb-4 p-3 bg-(--accent) rounded-lg">
            <Icon name="lucide:triangle-alert" class="h-5 w-5 text-yellow-500" />
            <p class="text-sm text-(--muted-foreground)">
                These features are experimental and may not work as expected. Use at your own risk.
            </p>
        </div>
        
        <div class="divide-y divide-(--border)">
            <Switch 
                id="dynamicLoading" 
                label="Dynamic Loading"
                description="Automatically detect when a site can't load due to proxy errors and switch to a different configuration. If all configurations fail, you'll be redirected to the 404 page. Configuration changes are site-specific and revert when you leave the site."
            />
        </div>
    </div>
</SettingsLayout>

<script>
    import { StoreManager } from "@utils/storage";

    const initExperiments = (storage: StoreManager<"radius||settings">) => {
        const dynamicLoadingSwitch = document.getElementById("switch-dynamicLoading");

        if (!dynamicLoadingSwitch) return;

        // Load saved state
        const dynamicLoadingEnabled = storage.getVal("experimentDynamicLoading") === "true";

        // Set initial state
        if (dynamicLoadingEnabled) {
            dynamicLoadingSwitch.setAttribute("aria-checked", "true");
            dynamicLoadingSwitch.setAttribute("data-state", "checked");
            const thumb = dynamicLoadingSwitch.querySelector("span");
            if (thumb) thumb.setAttribute("data-state", "checked");
        }

        // Listen for changes
        dynamicLoadingSwitch.addEventListener("switch-change", async (e: Event) => {
            const customEvent = e as CustomEvent<{ checked: boolean }>;
            storage.setVal("experimentDynamicLoading", customEvent.detail.checked.toString());
            // Sync the state with the DynamicLoading instance
            const { getDynamicLoading } = await import("@utils/dynamic-loading");
            getDynamicLoading().setEnabled(customEvent.detail.checked);
        });
    };

    document.addEventListener("astro:page-load", () => {
        try {
            const storageManager = new StoreManager<"radius||settings">("radius||settings");
            initExperiments(storageManager);
        } catch (err) {
            console.log(err);
        }
    });
</script>
